<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns='http://www.liquibase.org/xml/ns/dbchangelog/1.9' xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' xsi:schemaLocation='http://www.liquibase.org/xml/ns/dbchangelog/1.9 http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd'>
  <changeSet author='KFS50' id='CreateTable_ca_icr_acct_t'>
    <comment>KFSMI-KFSMI-6921 Create Account and A21SubAccount ICR collection tables</comment>
    <createTable tableName='CA_ICR_ACCT_T'>
      <column name='CA_ICR_ACCT_GNRTD_ID' type='NUMBER(10,0)' defaultValueNumeric='0'>
        <constraints primaryKey='true' nullable='false' />
      </column>
      <column name='OBJ_ID' type='VARCHAR2(36)'>
      	<constraints nullable='false' />
      </column>
      <column name='VER_NBR' type='NUMBER(8,0)' defaultValueNumeric='1'>
      	<constraints nullable='false' />
      </column>
      <column name='FIN_COA_CD' type='VARCHAR2(2)' defaultValue='' >
      	<constraints nullable='false' />
      </column>
      <column name='ACCOUNT_NBR' type='VARCHAR2(7)'>
      	<constraints nullable='false' />
      </column>
      <column name='ICR_FIN_COA_CD' type='VARCHAR2(2)' >
      	<constraints nullable='true' />
      </column>
      <column name='ICR_FIN_ACCT_NBR' type='VARCHAR2(7)' >
      	<constraints nullable='true' />
      </column>
      <column name='ACLN_PCT' type='VARCHAR2(45)' >
      	<constraints nullable='true' />
      </column>
      <column name='DOBJ_MAINT_CD_ACTV_IND' type='VARCHAR2(1)' >
      	<constraints nullable='false' />
      </column>
    </createTable>
    
    <modifySql dbms='mysql'>
      <replace replace='VARCHAR2' with='VARCHAR' />
    </modifySql>
    <modifySql dbms='mysql'>
      <replace replace='NUMBER' with='DECIMAL' />
    </modifySql>
  </changeSet>

	<changeSet author="KFS50" id="ca_icr_acct_seq_oracle" dbms="oracle">
    	<createSequence sequenceName="CA_ICR_ACCT_SEQ" startValue="10000"/>
  	</changeSet>
   
	<changeSet author="KFS50" id="ca_icr_acct_seq_mysql" dbms="mysql">
	  	<createTable tableName="CA_ICR_ACCT_SEQ">
	  		<column name="ID" type="BIGINT(19)" autoIncrement="true">
	  			<constraints nullable="false" primaryKey="true"/>
	  		</column>
	  	</createTable>
	  	<sql>ALTER TABLE ca_icr_acct_seq AUTO_INCREMENT=10000</sql>
  	</changeSet>
 
  <changeSet author='KFS50' id='CreateTable_ca_a21_icr_acct_t'>
    <comment>KFSMI-KFSMI-6921 Create Account and A21SubAccount ICR collection tables</comment>
    <createTable tableName='CA_A21_ICR_ACCT_T'>
      <column name='CA_A21_ICR_ACCT_GNRTD_ID' type='NUMBER(10,0)' defaultValueNumeric='0'>
        <constraints primaryKey='true' nullable='false' />
      </column>
      <column name='OBJ_ID' type='VARCHAR2(36)'>
      	<constraints nullable='false' />
      </column>
      <column name='VER_NBR' type='NUMBER(8,0)' defaultValueNumeric='1' >
      	<constraints nullable='false' />
      </column>
      <column name='FIN_COA_CD' type='VARCHAR2(2)' defaultValue='' >
      	<constraints nullable='false' />
      </column>
      <column name='ACCOUNT_NBR' type='VARCHAR2(7)' >
      	<constraints nullable='false' />
      </column>
      <column name='SUB_ACCT_NBR' type='VARCHAR2(5)' >
      	<constraints nullable='false' />
      </column>
      <column name='ICR_FIN_COA_CD' type='VARCHAR2(2)' >
      	<constraints nullable='false' />
      </column>
      <column name='ICR_FIN_ACCT_NBR' type='VARCHAR2(7)' >
      	<constraints nullable='true' />
      </column>
      <column name='ACLN_PCT' type='VARCHAR2(45)' >
      	<constraints nullable='true' />
      </column>
      <column name='DOBJ_MAINT_CD_ACTV_IND' type='VARCHAR2(1)' >
      	<constraints nullable='false' />
      </column>
    </createTable>
    <modifySql dbms='mysql'>
      <replace replace='VARCHAR2' with='VARCHAR' />
    </modifySql>
    <modifySql dbms='mysql'>
      <replace replace='NUMBER' with='DECIMAL' />
    </modifySql>
  </changeSet>
  	<changeSet author="KFS50" id="ca_a21_icr_acct_seq_oracle" dbms="oracle">
    	<createSequence sequenceName="CA_A21_ICR_ACCT_SEQ" startValue="10000"/>
  	</changeSet>
   
	<changeSet author="KFS50" id="ca_a21_icr_acct_seq_mysql" dbms="mysql">
	  	<createTable tableName="CA_A21_ICR_ACCT_SEQ">
	  		<column name="ID" type="BIGINT(19)" autoIncrement="true">
	  			<constraints nullable="false" primaryKey="true"/>
	  		</column>
	  	</createTable>
	  	<sql>ALTER TABLE ca_a21_icr_acct_seq AUTO_INCREMENT=10000</sql>
  	</changeSet>
  	
  	  <changeSet author='KFS50' id='CreateTable_CA_PRIOR_YR_ICR_ACCT_T'>
    <comment>KFSMI-KFSMI-6963 Data conversion script for ICR accounts and modification on the ICR tables</comment>
    <createTable tableName='CA_PRIOR_YR_ICR_ACCT_T'>
      <column name='CA_PRIOR_YR_ICR_ACCT_GNRTD_ID' type='NUMBER(10,0)' defaultValueNumeric='0'>
      	<constraints primaryKey = "true" nullable="false" />
      </column>
      <column name='OBJ_ID' type='VARCHAR2(36)' >
      	<constraints nullable='false' />
     </column>
      <column name='VER_NBR' type='NUMBER(8,0)' defaultValueNumeric='1'>
      <constraints nullable='false' />
      </column>
      <column name='FIN_COA_CD' type='VARCHAR2(2)' defaultValue=''>
      <constraints nullable='false' />
      </column>
      <column name='ACCOUNT_NBR' type='VARCHAR2(7)' >
      <constraints nullable='false' />
      </column>
      <column name='ICR_FIN_COA_CD' type='VARCHAR2(2)' >
      <constraints nullable='true' />
      </column>
      <column name='ICR_FIN_ACCT_NBR' type='VARCHAR2(7)' >
      <constraints nullable='true' />
      </column>
      <column name='ACLN_PCT' type='VARCHAR2(45)'>
      <constraints nullable='true' />
      </column>
      <column name='DOBJ_MAINT_CD_ACTV_IND' type='VARCHAR2(1)'>
      <constraints nullable='false' />
      </column>
    </createTable>
    <modifySql dbms='mysql'>
      <replace replace='VARCHAR2' with='VARCHAR' />
    </modifySql>
    <modifySql dbms='mysql'>
      <replace replace='NUMBER' with='DECIMAL' />
    </modifySql>
  </changeSet>
  
  	<changeSet author='KFS50' id='Convert_CA_ICR_ACCT_T_mysql' dbms='mysql' >
  	<sql>
## MySQL data conversion for CA Account ICR values

## Set the acct seq to current max of ICR accounts - default to 10000
set @acct_seq = IFNULL((select max(id) from ca_icr_acct_seq), 10000);
select @acct_seq;

## CA_ICR_ACCT_T
INSERT CA_ICR_ACCT_T
(CA_ICR_ACCT_GNRTD_ID,
OBJ_ID,
VER_NBR,
FIN_COA_CD,
ACCOUNT_NBR,
ICR_FIN_COA_CD,
ICR_FIN_ACCT_NBR,
ACLN_PCT,
DOBJ_MAINT_CD_ACTV_IND)
SELECT @acct_seq := @acct_seq + 1, uuid(), 1, FIN_COA_CD, ACCOUNT_NBR, ICR_FIN_COA_CD, ICR_ACCOUNT_NBR, 100, 'Y'
  FROM CA_ACCOUNT_T
 WHERE ICR_ACCOUNT_NBR IS NOT NULL
   AND ICR_FIN_COA_CD IS NOT NULL
;

#Data conversion completed, increase the current max on the sequence table
INSERT ca_icr_acct_seq value (@acct_seq);

## -------------------------------------------------------------------- ##

## Set the acct seq to current max of A21 ICR accounts - default to 10000
set @a21_acct_seq = IFNULL((select max(id) from ca_a21_icr_acct_seq), 10000);
select @a21_acct_seq;

INSERT INTO CA_A21_ICR_ACCT_T
(CA_A21_ICR_ACCT_GNRTD_ID,
OBJ_ID,
VER_NBR,
FIN_COA_CD,
ACCOUNT_NBR,
SUB_ACCT_NBR,
ICR_FIN_COA_CD,
ICR_FIN_ACCT_NBR,
ACLN_PCT,
DOBJ_MAINT_CD_ACTV_IND)
SELECT @a21_acct_seq := @a21_acct_seq + 1, uuid(), 1, FIN_COA_CD, ACCOUNT_NBR, SUB_ACCT_NBR, ICR_FIN_COA_CD, ICR_ACCOUNT_NBR, 100, 'Y'
  FROM CA_A21_SUB_ACCT_T
 WHERE ICR_ACCOUNT_NBR IS NOT NULL
   AND ICR_FIN_COA_CD IS NOT NULL
;

#Data conversion completed, increase the current max on the sequence table
INSERT ca_a21_icr_acct_seq value (@a21_acct_seq);
  	</sql>
  	</changeSet>
   	<changeSet author='KFS50' id='Convert_CA_ICR_ACCT_T_oracle' dbms='oracle' >
  	<sql>
 -- Conversion script to take the ICR COA/Account Number and populate into
-- the new ICR collection tables
-- 1) CA_ACCOUNT_T -> CA_ICR_ACCT_T
-- 2) CA_A21_SUB_ACCT_T -> CA_A21_ICR_ACCT_T
-- 3) TODO? Prior year account

-- CA_ICR_ACCT_T
INSERT INTO 'CA_ICR_ACCT_T'
('CA_ICR_ACCT_GNRTD_ID',
'OBJ_ID',
'VER_NBR',
'FIN_COA_CD',
'ACCOUNT_NBR',
'ICR_FIN_COA_CD',
'ICR_FIN_ACCT_NBR',
'ACLN_PCT',
'DOBJ_MAINT_CD_ACTV_IND')
SELECT CA_ICR_ACCT_SEQ.nextval, sys_guid(), 1, FIN_COA_CD, ACCOUNT_NBR, ICR_FIN_COA_CD, ICR_ACCOUNT_NBR, 100, 'Y'
  FROM CA_ACCOUNT_T
 WHERE ICR_ACCOUNT_NBR IS NOT NULL
   AND ICR_FIN_COA_CD IS NOT NULL
;

-- CA_ICR_ACCT_T
INSERT INTO 'CA_A21_ICR_ACCT_T'
('CA_A21_ICR_ACCT_GNRTD_ID',
'OBJ_ID',
'VER_NBR',
'FIN_COA_CD',
'ACCOUNT_NBR',
'SUB_ACCT_NBR',
'ICR_FIN_COA_CD',
'ICR_FIN_ACCT_NBR',
'ACLN_PCT',
'DOBJ_MAINT_CD_ACTV_IND')
SELECT CA_A21_ICR_ACCT_SEQ.nextval, sys_guid(), 1, FIN_COA_CD, ACCOUNT_NBR, SUB_ACCT_NBR, ICR_FIN_COA_CD, ICR_ACCOUNT_NBR, 100, 'Y'
  FROM CA_A21_SUB_ACCT_T
 WHERE ICR_ACCOUNT_NBR IS NOT NULL
   AND ICR_FIN_COA_CD IS NOT NULL
; 	
  	</sql>
  	</changeSet>
 
</databaseChangeLog>