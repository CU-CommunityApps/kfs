<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns='http://www.liquibase.org/xml/ns/dbchangelog/1.9' xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' xsi:schemaLocation='http://www.liquibase.org/xml/ns/dbchangelog/1.9 http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd'>
  <changeSet author='David' id='5762-1-1' failOnError='true' dbms='oracle'>
    <comment>Role 31 (Accounts Receivable Manager) should be able to create and edit Organization Options. </comment>
    <sql>&lt;![CDATA[SET SERVEROUTPUT ON

DECLARE
  new_perm_id NUMBER;
  new_attr_data_id NUMBER;
  new_role_perm_id NUMBER;
  target_perm_id VARCHAR2(5);
  target_role_id VARCHAR2(5);
  
BEGIN

  target_perm_id := '248';
  target_role_id := '31';
   
  -- create a new permission for initiate document OOPT
  select max(to_number(perm_id)) into new_perm_id from krim_perm_t;
  new_perm_id := new_perm_id + 1;
  DBMS_OUTPUT.PUT_LINE('new_perm_id: ' || new_perm_id);

  INSERT INTO KRIM_PERM_T
    (PERM_ID, OBJ_ID, VER_NBR, PERM_TMPL_ID, NMSPC_CD, NM, DESC_TXT, ACTV_IND)
    VALUES (TO_CHAR(new_perm_id), SYS_GUID(), 1, 10, 'KFS-AR', 'Initiate Document', 'Authorizes the initiation of the the Organization Options', 'Y');

  -- add the new permission details
  select max(to_number(attr_data_id)) into new_attr_data_id from KRIM_PERM_ATTR_DATA_T;
  new_attr_data_id := new_attr_data_id + 1;
  DBMS_OUTPUT.PUT_LINE('new_attr_data_id: ' || new_attr_data_id);
  
  INSERT INTO KRIM_PERM_ATTR_DATA_T
    (ATTR_DATA_ID, OBJ_ID, VER_NBR, PERM_ID, KIM_TYP_ID, KIM_ATTR_DEFN_ID, ATTR_VAL)
    VALUES (TO_CHAR(new_attr_data_id), SYS_GUID(), 1, TO_CHAR(new_perm_id), '3', '13', 'OOPT');
  
  -- add the new permission to the role 31 - Accounts Receivable Manager
  select max(to_number(role_perm_id)) into new_role_perm_id from KRIM_ROLE_PERM_T;
  new_role_perm_id := new_role_perm_id + 1;
  DBMS_OUTPUT.PUT_LINE('new_role_perm_id_1: ' || new_role_perm_id);
  
  INSERT INTO KRIM_ROLE_PERM_T
    (ROLE_PERM_ID, OBJ_ID, VER_NBR, ROLE_ID, PERM_ID, ACTV_IND)
    VALUES (TO_CHAR(new_role_perm_id), SYS_GUID(), 1, target_role_id, TO_CHAR(new_perm_id), 'Y') ;

  -- add permission 248 to the role 31
  select max(to_number(role_perm_id)) into new_role_perm_id from KRIM_ROLE_PERM_T;
  new_role_perm_id := new_role_perm_id + 1;
  DBMS_OUTPUT.PUT_LINE('new_role_perm_id_2: ' || new_role_perm_id);
  
  INSERT INTO KRIM_ROLE_PERM_T
    (ROLE_PERM_ID, OBJ_ID, VER_NBR, ROLE_ID, PERM_ID, ACTV_IND)
    VALUES (TO_CHAR(new_role_perm_id), SYS_GUID(), 1, target_role_id, target_perm_id, 'Y') ;

  DBMS_OUTPUT.PUT_LINE('Done');
END;]]&gt;</sql>
  </changeSet>
  <changeSet author='David' id='5762-1-2' failOnError='true' dbms='mysql'>
    <comment>Role 31 (Accounts Receivable Manager) should be able to create and edit Organization Options. </comment>
    <sql>&lt;![CDATA[
--1. create a new permission

set @newPermId =(SELECT MAX(CAST(perm_id as UNSIGNED))+1 FROM krim_perm_t);
select @newPermId;

INSERT INTO KRIM_PERM_T
(PERM_ID, OBJ_ID, VER_NBR, PERM_TMPL_ID, NMSPC_CD, NM, DESC_TXT, ACTV_IND)
VALUES (@newPermId, uuid(), 1, 10, 'KFS-AR', 'Initiate Document', 'Authorizes the initiation of the the Organization Options', 'Y');
--* next_perm_id: eg) '10002'

--2. Add the new permission details
set @newAttrDataId =(SELECT MAX(CAST(attr_data_id as UNSIGNED))+1 FROM KRIM_PERM_ATTR_DATA_T);
INSERT INTO KRIM_PERM_ATTR_DATA_T
(ATTR_DATA_ID, OBJ_ID, VER_NBR, PERM_ID, KIM_TYP_ID, KIM_ATTR_DEFN_ID, ATTR_VAL)
VALUES (@newAttrDataId, uuid(), 1, @newPermId, '3', '13', 'OOPT');
--* next_attr_data_id: eg) '10008'
--* next_perm_id: eg) '10002'

--3. Add the new permission to role 31 (Accounts Receivable Manager)
set @newRolePermId =(SELECT MAX(CAST(role_perm_id as UNSIGNED))+1 FROM KRIM_ROLE_PERM_T);
INSERT INTO KRIM_ROLE_PERM_T
(ROLE_PERM_ID, OBJ_ID, VER_NBR, ROLE_ID, PERM_ID, ACTV_IND)
VALUES (@newRolePermId, uuid(), 1, '31', @newPermId, 'Y') ;
--* next_role_perm_id: eg) '1000'

--4. Add permission 248 to role 31
set @newRolePermId =(SELECT MAX(CAST(role_perm_id as UNSIGNED))+1 FROM KRIM_ROLE_PERM_T);
INSERT INTO KRIM_ROLE_PERM_T
(ROLE_PERM_ID, OBJ_ID, VER_NBR, ROLE_ID, PERM_ID, ACTV_IND)
VALUES (@newRolePermId, uuid(), 1, '31', '248', 'Y') ;
--* next_role_perm_id: eg) '1001']]&gt;</sql>
  </changeSet>
</databaseChangeLog>