<?xml version="1.0"?>
<project name="kuali" default="dist-local" basedir=".">
	<!-- run the help target to view usage instructions for public targets -->
	<target name="dist-local" if="is.local.build" depends="clean,filter-project,filter-local" description="Prepare local configuration files and tokenized resources and deploy tomcat context file on development workstation">
		<copy file="${metainf.directory}/${context.file}" tofile="${appserver.localhost.dir}/${ant.project.name}-${build.environment}.xml" overwrite="true" />
	</target>

	<target name="test-local" depends="dist-local,make-tests,test" description="Run all unit tests and format results"/>

	<target name="echo-properties" depends="init-properties" description="Print all build properties that have been set">
		<echoproperties />
	</target>

	<target name="clean" depends="clean-project,clean-local" description="Remove all build output" />

	<target name="init-property-files">
		<property file="${user.home}/${ant.project.name}-build.properties" />
		<property file="build.properties" />
	</target>

	<target name="init-properties" depends="init-property-files">
		<tstamp><format property="project.cvs.tag" pattern="MM/dd/yyyy hh:mm aa" /></tstamp>
		<condition property="context.docbase" value=' docBase="${basedir}${file.separator}work${file.separator}web-root"'><equals arg1="${is.local.build}" arg2="true" /></condition>
		<property name="context.docbase" value="" />
		<condition property="datasource.url" value="${mysql.datasource.url}"><equals arg1="${ojb.platform}" arg2="${mysql.ojb.platform}" /></condition>
		<property name="datasource.url" value="${oracle.datasource.url}" />
		<condition property="use.p6spy.local">
			<and>
				<equals arg1="${is.local.build}" arg2="true" />
				<equals arg1="${use.p6spy}" arg2="true" />
			</and>
		</condition>
		<condition property="driver.class" value="${p6spy.driver.class}"><equals arg1="${use.p6spy.local}" arg2="true"/></condition>
		<condition property="driver.class" value="${mysql.driver.class}"><equals arg1="${ojb.platform}" arg2="${mysql.ojb.platform}" /></condition>
		<property name="driver.class" value="${oracle.driver.class}" />
		<condition property="p6spy.real.driver.class" value="${mysql.driver.class}"><equals arg1="${ojb.platform}" arg2="${mysql.ojb.platform}" /></condition>
		<property name="p6spy.real.driver.class" value="${oracle.driver.class}" />
		<condition property="datasource.ojb.sequencemanager.class" value="${mysql.sequence.manager.class}"><equals arg1="${ojb.platform}" arg2="${mysql.ojb.platform}" /></condition>
		<property name="datasource.ojb.sequencemanager.class" value="${oracle.sequence.manager.class}" />
	    <condition property="datasource.platform.class" value="${mysql.database.platform}"><equals arg1="${ojb.platform}" arg2="${mysql.ojb.platform}" /></condition>
		<property name="datasource.platform.class" value="${oracle.database.platform}" />
	    <condition property="rice.workflow.datasource.platform.class" value="${mysql.workflow.database.platform}"><equals arg1="${ojb.platform}" arg2="${mysql.ojb.platform}" /></condition>
		<property name="rice.workflow.datasource.platform.class" value="${oracle.workflow.database.platform}" />
		<condition property="appenders" value="INFO, LogFile, StdOut"><equals arg1="${is.local.build}" arg2="true" /></condition>
		<property name="appenders" value="INFO, LogFile" />
		<condition property="startup.stats.mailing.list" value="${configuration.manager.mailing.list}"><equals arg1="${build.environment}" arg2="cnv" /></condition>
		<property name="startup.stats.mailing.list" value="" />
		<condition property="use.quartz.jdbc.jobstore" value="false"><equals arg1="${is.local.build}" arg2="true" /></condition>
		<property name="use.quartz.jdbc.jobstore" value="true" />
		<condition property="rice.dev.mode" value="true"><equals arg1="${is.local.build}" arg2="true" /></condition>
		<property name="rice.dev.mode" value="false" />
		<condition property="rice.message.persistence" value="false"><equals arg1="${is.local.build}" arg2="true" /></condition>
		<property name="rice.message.persistence" value="true" />
		<condition property="rice.use.quartz.database" value="true">
			<and>
				<not><equals arg1="${use.quartz.scheduling}" arg2="true" /></not>
				<not><equals arg1="${is.local.build}" arg2="true" /></not>
			</and>
		</condition>
		<property name="rice.use.quartz.database" value="false" />
		<condition property="rice.exception.routing.immediate" value="true"><equals arg1="${use.quartz.scheduling}" arg2="false" /></condition>
		<property name="rice.exception.routing.immediate" value="false" />
		<loadfile property="configuration" srcfile="${build.project.directory}/${configuration.file}"><filterchain><expandproperties/></filterchain></loadfile>
		<loadfile property="p6spy" srcfile="${build.project.directory}/${p6spy.file}"><filterchain><expandproperties/></filterchain></loadfile>
		<loadfile property="web" srcfile="${build.project.directory}/${web.file}"><filterchain><expandproperties/></filterchain></loadfile>
		<loadfile property="context" srcfile="${build.appserver.directory}/${context.file}"><filterchain><expandproperties/></filterchain></loadfile>
		<loadfile property="log4j" srcfile="${user.home}/${log4j.file}" failonerror="false"><filterchain><expandproperties/></filterchain></loadfile>
		<loadfile property="log4j" srcfile="${build.external.directory}/${log4j.file}"><filterchain><expandproperties/></filterchain></loadfile>
		<loadfile property="security" srcfile="${build.external.directory}/${security.file}"><filterchain><expandproperties/></filterchain></loadfile>
	</target>

	<target name="init-make-references" depends="init-properties">
		<path id="compile.source.classpath">
			<fileset dir="${appserver.lib.dir}" includes="*.jar" />
			<fileset dir="${lib.directory}" includes="*.jar" />
		</path>
		<path id="compile.tests.classpath">
			<path refid="compile.source.classpath" />
			<fileset dir="${test.lib.directory}" includes="*.jar" />
			<pathelement location="${appserver.classes.dir}"/>
		</path>
		<patternset id="non.java.resources">
			<include name="**/*.properties" />
			<include name="**/*.dtd" />
			<include name="**/*.xml" />
			<include name="**/*.html" />
			<include name="**/*.xsd" />
		</patternset>
	</target>

	<target name="clean-project" depends="init-property-files">
		<delete failonerror="false">
			<fileset dir="${basedir}" includes="${source.directory}/${configuration.file},${source.directory}/${p6spy.file},${webinf.directory}/${web.file},${lib.directory}/${log4j.library.file},${war.directory}/**/**,${test.directory}/**/**,*.war,*.zip,${help.directory}/**/**,${webroot.directory}/${rice.application}/**/**,${webroot.directory}/${tags.directory}/${rice.application}/**/**,${webroot.directory}/${workflow.application}/**/**,${database.directory}/${rice.name}/**/**,${licenses.directory}/${rice.name}/**/**" />
		</delete>
	</target>

	<target name="clean-local" if="is.local.build" depends="init-property-files">
		<delete failonerror="false" includeemptydirs="true">
			<fileset dir="${external.config.directory}" includes="**/${ant.project.name}/"/>
		</delete>
		<delete failonerror="false">
			<fileset dir="${appserver.lib.dir}">
				<or>
					<present targetdir="${build.directory}" />
					<present targetdir="${build.appserver.directory}" />
					<present targetdir="${drivers.directory}" />
				</or>
			</fileset>
		</delete>
		<delete failonerror="false">
			<fileset dir="${appserver.classes.dir}">
				<present targetdir="${build.appserver.directory}" />
			</fileset>
		</delete>
		<delete failonerror="false">
			<fileset dir="${appserver.localhost.dir}" includes="${ant.project.name}-*.xml" />
		</delete>
		<delete failonerror="false">
			<fileset dir="${appserver.deploy.dir}" includes="${ant.project.name}-*.war,${ant.project.name}-*/**" />
		</delete>
		<!-- commenting out cause it cause things are already slow and this makes them slower
		<delete failonerror="false" includeemptydirs="true">
			<fileset dir="${appserver.work.dir}" includes="${ant.project.name}-*/**" />
		</delete> -->
	</target>

	<target name="filter-project-log4j" unless="use.p6spy.local" depends="init-properties">
		<copy file="${build.directory}/${log4j.library.file}" todir="${lib.directory}"/>
	</target>

	<target name="filter-project-p6spy" if="use.p6spy.local" depends="filter-project-log4j">
		<copy file="${build.directory}/${log4j.library.file}" todir="${appserver.lib.dir}"/>
	</target>

	<target name="filter-project" depends="filter-project-p6spy">
		<unzip dest="${help.directory}" src="${build.project.directory}/help.zip" />
		<unzip dest="${webroot.directory}" src="${build.project.directory}/${rice.name}-${rice.version}${rice.output.web.suffix}" />
		<unzip dest="${database.directory}/${rice.name}" src="${build.project.directory}/${rice.name}-${rice.version}${rice.output.ddl.suffix}" />
		<unzip dest="${licenses.directory}/${rice.name}" src="${build.project.directory}/${rice.name}-${rice.version}${rice.output.licenses.suffix}" />
		<echo file="${source.directory}/${configuration.file}" message="${configuration}" />
		<echo file="${source.directory}/${p6spy.file}" message="${p6spy}" />
		<echo file="${webinf.directory}/${web.file}" message="${web}" />
		<mkdir dir="${metainf.directory}" />
		<echo file="${metainf.directory}/${context.file}" message="${context}" />
	</target>

	<target name="filter-local" if="is.local.build" depends="init-properties">
		<copy file="${build.appserver.directory}/${carol.file}" todir="${appserver.classes.dir}" overwrite="true" />
		<copy todir="${appserver.lib.dir}" overwrite="true">
			<fileset dir="${build.appserver.directory}" includes="*.jar" />
		</copy>
		<copy todir="${appserver.lib.dir}" overwrite="true">
			<fileset dir="${drivers.directory}" />
		</copy>
		<mkdir dir="${settings.directory}" />
		<echo file="${log4j.settings.file}" message="${log4j}" />
		<mkdir dir="${security.directory}" />
		<echo file="${security.property.file}" message="${security}"  />
		<mkdir dir="${logs.directory}" />
		<echo file="${logs.directory}/${ant.project.name}.log" message="" />
		<copy todir="${external.work.directory}">
			<fileset dir="${build.work.directory}" />
		</copy>
	</target>

	<target name="make-source" depends="init-make-references,filter-project">
		<mkdir dir="${make-source.target.directory}" />
		<javac destdir="${make-source.target.directory}" srcdir="${source.directory}" debug="true" optimize="true" fork="true" memoryinitialsize="${compile.min.memory}" memorymaximumsize="${compile.max.memory}">
			<classpath refid="compile.source.classpath" />
		</javac>
		<copy todir="${make-source.target.directory}">
			<fileset dir="${source.directory}">
				<patternset refid="non.java.resources" />
			</fileset>
		</copy>
	</target>

	<target name="make-tests" depends="init-make-references,filter-project">
		<mkdir dir="${test.classes.directory}" />
		<javac destdir="${test.classes.directory}" debug="true" optimize="true" fork="true" memoryinitialsize="${compile.min.memory}" memorymaximumsize="${compile.max.memory}">
			<classpath refid="compile.tests.classpath" />
			<src path="${source.directory}" />
			<src path="${test.source.directory}" />
		</javac>
		<copy todir="${test.classes.directory}">
			<fileset dir="${test.source.directory}">
				<patternset refid="non.java.resources" />
				<include name="**/*.txt" />
			</fileset>
		</copy>
		<copy todir="${test.classes.directory}">
			<fileset dir="${source.directory}">
				<patternset refid="non.java.resources" />
			</fileset>
		</copy>
	</target>

	<target name="make-zips" depends="filter-local">
		<zip destfile="settings.zip" basedir="${settings.directory}" />
		<zip destfile="security.zip" basedir="${security.directory}" />
		<zip destfile="skel.zip" basedir="${external.work.directory}" />
	</target>

	<target name="make-batch" depends="clean,dist-local,make-source">
		<property file="${appserver.home}/brte-script-build.properties" />
		<copy todir="${batch.script.distribution.directory}" overwrite="true">
			<fileset dir="${batch.script.directory}" />
			<filterset>
				<filter token="batch-script-prefix" value="${batch.script.prefix}" />
				<filter token="batch-command-prefix" value="${batch.command.prefix}" />
				<filter token="batch-script-suffix" value="${batch.script.suffix}" />
			</filterset>
		</copy>
	</target>

	<!-- please be careful if you muck with these settings - you can seriously hose the continuous integration process -->
	<target name="test">
		<mkdir dir="${test.temp.directory}" />
		<mkdir dir="${test.xml.results.directory}" />
		<junit showoutput="true" fork="true" forkmode="once" failureproperty="tests.failed" errorproperty="tests.errored" tempdir="${test.temp.directory}" maxmemory="512M">
			<jvmarg value="-Dorg.kuali.test.KualiTestBase.skipOpenOrInProgressOrReopenedJiraIssues"/>
			<classpath>
				<path refid="compile.tests.classpath" />
				<pathelement location="${test.classes.directory}" />
			</classpath>
			<formatter type="xml" />
			<batchtest todir="${test.xml.results.directory}">
				<fileset dir="${test.source.directory}">
					<include name="${tests.includes}" />
					<exclude name="**/TransactionalDocumentRuleTest.java" />
					<exclude name="**/${test.spring.shutdown}.java" />
				</fileset>
			</batchtest>
			<test name="org.kuali.kfs.context.${test.spring.shutdown}" todir="${test.xml.results.directory}" />
		</junit>
		<mkdir dir="${test.html.results.directory}" />
		<junitreport todir="${test.html.results.directory}">
			<fileset dir="${test.xml.results.directory}">
				<include name="TEST-*.xml" />
			</fileset>
			<report format="frames" todir="${test.html.results.directory}" />
		</junitreport>
		<echo message="Generated test results: ${test.html.results.directory}/index.html" />
	</target>

	<target name="dist" depends="make-source">
		<copy todir="${war.directory}">
			<fileset dir="${webroot.directory}" excludes="WEB-INF/classes/**/**" />
		</copy>
		<jar jarfile="${ant.project.name}-${build.environment}.war" basedir="${war.directory}" compress="false" />
	</target>

	<target name="continuous-integration" depends="clean,make-tests,test">
		<fail if="tests.failed" message="Tests failed" />
	</target>

	<target name="help" depends="init-properties" description="Describe public targets">
		<echo>--- OVERVIEW ---

	the following configuration files are involved in the build process
			- build.xml
			- build.properties
			- build/*
			- ${ant.project.name}-build.properties in ${user.home}

	you should start using this build script as follows

			1. copy the ${ant.project.name}-build.properties from ${build.user.directory} in
			${basedir} to ${user.home}
			    - fill in the missing values in the sections related to tempoarily and permanently customizing the
			      build for your machine (you do not need to worry about the rice development section)
			    - override other property values in ${user.home}/${ant.project.name}-build.properties as needed
			    - save your changes
			
			2. run the echo-properties target and review the results

			3. follow the instructions associated with the dist-local target and run that target
						
			4. right click on the root project directory and select "Refresh"
			
			5. click the "Run/Stop/Restart MyEclipse Application Servers" button in the "Java (default)" perspective in
			eclipse to start tomcat
			
			6. launch a browser and access http://localhost:8080/kuali-dev

	you can override the default log4j settings for your local deployments by copying
		${basedir}/${build.external.directory}/${log4j.file} to
			${user.home}/${log4j.file} and modifying as desired.  you will also need to run the dist-local target
			for this change to take effect.

			--- TARGETS ---

			dist-local: prepares tokenized resources and local configuration files and deploys tomcat context file on development workstation
			- this target should be run each time you update the project, change property values in ${user.home}/${ant.project.name}-build.properties,
			or make a change that you want to apply to the application workflow plugin
			- tomcat should not be running when you are executing this target

			test-local: runs all project tests and generates results
             - criteria for running dist-local must be met before running this target
			- you can customize the set of tests that run by modifying the value of tests.includes in ${user.home}/${ant.project.name}-build.propertie
			- tomcat should not be running when you execute this target

			echo-properties: executes ant echoproperties task, thereby printing out all the properties that have been set

			clean: removes all build output
		</echo>
	</target>

	<!-- CONFIGURATION MANAGEMENT TARGETS -->

	<target name="setup-rice" depends="init-property-files">
		<condition property="os.safe.driver.path" value="c:${drivers.directory}/ojdbc14.jar">
			<os family="windows"/>
		</condition>
		<property name="os.safe.driver.path" value="${drivers.directory}/ojdbc14.jar" />
		<maven goals="install:install-file" options="-U -DgroupId=com.oracle -DartifactId=ojdbc14 -Dversion=10.1.0.3.0 -Dpackaging=jar -Dfile=${os.safe.driver.path}" />
		<copy todir="${user.home}/kuali">
			<fileset dir="${build.user.directory}/${ant.project.name}" includes="**/**" />
			<filterset>
				<filter token="dev-rice-password" value="${rice.datasource.password.dev}" />
				<filter token="test-rice-password" value="${rice.datasource.password.test}" />
			</filterset>
		</copy>
		<maven goals="clean:clean install source:jar javadoc:jar" options="-U -Pinstall-kns-dev -Dpackaging=jar" />
		<touch file="${rice.project.directory}/pom.xml" />
	</target>

	<target name="update-rice-dev" depends="update-rice-basic,dist-local" />

	<target name="update-rice" depends="update-rice-basic,update-rice-extended,dist-local" />

	<target name="update-rice-basic" depends="init-property-files,update-rice-jars,update-rice-web" />

	<target name="update-rice-jars" depends="init-property-files">
		<delete>
			<fileset dir="${basedir}" includes="${lib.directory}/${rice.output.file.prefix}${rice.output.lib.suffix}" />
		</delete>
		<maven goals="clean:clean package" />
		<copy todir="${lib.directory}" flatten="true">
			<fileset dir="${rice.project.directory}" includes="${rice.output.directories}${rice.output.file.prefix}${rice.version}${rice.output.lib.suffix}" excludes="${rice.excludes}" />
		</copy>
		<get src="https://onestart.iu.edu/dav/MY/maven-mirror/maven2/${workflow.name}/${workflow.name}/${workflow.version}/${workflow.name}-${workflow.version}.jar" dest="${basedir}/${lib.directory}/${rice.name}-${workflow.name}-${workflow.version}.jar" />
	</target>
	
	<target name="update-rice-web" depends="init-property-files">
		<delete>
			<fileset dir="${build.project.directory}" includes="${rice.name}*${rice.output.web.suffix}" />
		</delete>
		<zip destfile="${build.project.directory}/${rice.name}-${rice.version}${rice.output.web.suffix}" basedir="${rice.sampleapp.directory}" includes="${rice.application}/**/**,${tags.directory}/${rice.application}/**/*.tag,${workflow.application}/**/**" excludes="**/CVS" />
	</target>

	<target name="update-rice-extended" depends="init-property-files,update-rice-kuali-dependencies,update-rice-ddl,update-rice-licenses" />

	<target name="update-rice-kuali-dependencies" depends="init-property-files">
		<delete>
			<fileset dir="${dependencies.project.directory}" includes="${rice.output.file.prefix}" />
		</delete>
		<maven goals="source:jar javadoc:jar" />
		<copy todir="${dependencies.project.directory}">
			<fileset dir="${rice.project.directory}" includes="${rice.output.directories}${rice.output.file.prefix}${rice.version}${rice.output.src.suffix},${rice.output.directories}${rice.output.file.prefix}${rice.version}${rice.output.doc.suffix}" excludes="${rice.excludes}" />
			<chainedmapper>
				<flattenmapper />
				<globmapper from="*.jar" to="*.zip" />
			</chainedmapper>
		</copy>
		<!--<property name="${workflow.application}.workflow.environment" value="${build.environment}" />
		<property name="${workflow.application}.tomcat5.home" value="${appserver.home}" />
		<property name="${workflow.application}.plugin.dir" value="${basedir}" />
		<property name="${workflow.application}.institution" value="${ant.project.name}" />
		<property name="${workflow.application}.src.dist.loc" value="${workflow.project.directory}/dist" />
		<propertyset id="en-properties">
			<propertyref prefix="${workflow.application}."/>
			<mapper type="glob" from="${workflow.application}.*" to="*"/>
		</propertyset>
		<ant dir="${workflow.project.directory}" target="bundle-workflow" inheritall="false">
			<propertyset refid="${workflow.application}-properties" />
		</ant>
		<copy file="${workflow.project.directory}/dist/workflow_${workflow.version}.zip" tofile="${dependencies.project.directory}/${rice.name}-${workflow.name}-${workflow.version}-src.zip" overwrite="true"/>
		<ant dir="${workflow.project.directory}" target="clean" inheritall="false"/>
		<ant dir="${workflow.project.directory}" target="javadoc" inheritall="false">
			<propertyset refid="${workflow.application}-properties" />
		</ant>
		<zip destfile="${dependencies.project.directory}/${rice.name}-${workflow.name}-${workflow.version}-doc.zip" basedir="${workflow.project.directory}/dist/api" />-->
	</target>

	<target name="update-rice-ddl" depends="init-property-files">
		<delete>
			<fileset dir="${build.project.directory}" includes="${rice.name}*${rice.output.ddl.suffix}" />
		</delete>
		<mkdir dir="temp" />
		<copy todir="temp">
			<fileset dir="${rice.project.directory}" includes="${rice.ddl.files}" excludes="${rice.excludes},**/CVS" />
			<regexpmapper from="^.*\${file.separator}src\${file.separator}main\${file.separator}config\${file.separator}(.*)$$" to="\1" />
		</copy>
		<zip destfile="${build.project.directory}/${rice.name}-${rice.version}-ddl.zip" basedir="temp" />
		<delete dir="temp" />
	</target>

	<target name="update-rice-licenses" depends="init-property-files">
		<zip destfile="${build.project.directory}/${rice.name}-${rice.version}-licenses.zip" basedir="${rice.project.directory}/${licenses.directory}" excludes="**/CVS" />
	</target>
	
	<macrodef name="maven">
		<attribute name="goals" />
		<attribute name="options" default="--offline" />
		<sequential>
	        <java classname="org.codehaus.classworlds.Launcher" dir="${rice.project.directory}" fork="true" failonerror="true">
	        	<arg line="@{options} @{goals}"/>
	        	<sysproperty key="classworlds.conf" value="${maven.home.directory}/bin/m2.conf"/>
	        	<sysproperty key="maven.home" value="${maven.home.directory}"/>
	        	<sysproperty key="maven.test.skip" value="true"/>
	        	<classpath>
	        		<fileset dir="${maven.home.directory}/boot">
						<include name="classworlds-*.jar"/>
					</fileset>
	        	</classpath>
	        </java>
		</sequential>
	</macrodef>
</project>