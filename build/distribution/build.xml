<?xml version="1.0" encoding="UTF-8"?>
<project name="kfs" basedir="../.." default="package">
	<import file="${basedir}/build.xml" />
	<echo message="Reading File: ${basedir}/build/distribution/distribution.properties" />
	<property file="build/distribution/distribution.properties" />

    <typedef resource="org/tigris/subversion/svnant/svnantlib.xml">
            <classpath>
                    <fileset dir="build" includes="*.jar" />
            </classpath>
    </typedef>

	<target name="package" depends="prep-temp-dir,checkout-projects,replace-foundation-references,unpack-and-remove-rice-licenses,add-doc-files,make-javadoc-for-dist,zip-package"
			description="Pulls the project from the version control repository, manipulates the contents slightly, and packs it up for distribution on the Kuali web site.">
    	<delete dir="${all.temp.directory}" verbose="false" />
	</target>

	<target name="prep-temp-dir" depends="init-properties,init-additional-properties">
    	<delete dir="${all.temp.directory}" failonerror="false" />
    	<mkdir dir="${all.temp.directory}" />
	</target>

	<target name="checkout-projects" depends="init-properties,init-additional-properties,prep-temp-dir">
		<svn>
			<!-- export the main project -->
			<export srcurl="${kuali.svn.root}/${kfs.svn.module}/${kfs.svn.path}"
					destpath="${all.temp.directory}/kfs" />
			<!-- demo dataset -->
			<export srcurl="${kuali.svn.root}/${kfs.database.svn.module}/${kfs.database.demo.svn.path}"
					destpath="${all.temp.directory}/datasets/demo/kfs" />
			<export srcurl="${kuali.svn.root}/${rice.database.svn.module}/${rice.database.demo.svn.path}"
					destpath="${all.temp.directory}/datasets/demo/rice" />
			<!-- bootstrap dataset -->
			<export srcurl="${kuali.svn.root}/${kfs.database.svn.module}/${kfs.database.bootstrap.svn.path}"
					destpath="${all.temp.directory}/datasets/bootstrap/kfs" />
			<export srcurl="${kuali.svn.root}/${rice.database.svn.module}/${rice.database.bootstrap.svn.path}"
					destpath="${all.temp.directory}/datasets/bootstrap/rice" />
			<!-- impex tool -->
			<export srcurl="${kuali.svn.root}/${impex.tool.svn.module}/${impex.tool.svn.path}"
					destpath="${all.temp.directory}/impex" />
			<!-- rice -->
			<export srcurl="${kuali.svn.root}/${rice.svn.module}/${rice.svn.path}"
					destpath="${all.temp.directory}/rice" />
		</svn>
	</target>
	
	<target name="replace-foundation-references" depends="init-properties,init-additional-properties">
		<delete verbose="true">
			<fileset dir="${all.temp.directory}/kfs">
				<!-- remove the "build-foundation" build file -->
				<include name="build-foundation.xml" />
				<include name="build/properties/build-foundation.properties" />
				<!-- remove the distribution build files -->
				<include name="${build.distribution.directory}/build.xml" />
				<include name="${build.distribution.directory}/distribution.properties" />
				<include name="build/svn*.jar" />
				<include name="build/ganymed.jar" />
				<include name="build/drivers/*.jar" />
			</fileset>
		</delete>
	    <!-- remove foundation-only targets import from main build file -->
    	<replace file="${all.temp.directory}/kfs/build.xml">
      		<replacefilter token="&lt;import file=&quot;build-foundation.xml&quot;/&gt;" value="" />
      		<replacefilter token="&lt;import file=&quot;build-foundation.xml&quot;/&gt;" value="" />
    		<replacefilter token="&lt;format property=&quot;build.version&quot; pattern=&quot;MM/dd/yyyy hh:mm aa&quot; /&gt;" value="&lt;format property=&quot;build.version&quot; pattern=&quot;'KFS ${release.version.number}' MM/dd/yyyy hh:mm aa&quot; /&gt;" />
    	</replace>
		<!-- replace foundation URL references -->
		<replace dir="${all.temp.directory}">
			<include name="impex/*.properties*" />
			<include name="kfs/build/external/user/kfs-build.properties" />
			<include name="kfs/build/properties/*.properties" />
			<!-- SVN -->
      		<replacefilter token="https://test.kuali.org/svn/" value="" />
			<!-- database -->
      		<replacefilter token="mysql.datasource.url=jdbc:mysql://esdbk01.uits.indiana.edu:3306/$${datasource.username}" 
    		     value="mysql.datasource.url=jdbc:mysql://localhost:3306/$${datasource.username}" />
      		<replacefilter token="oracle.datasource.url=jdbc:oracle:thin:@esdbk02.uits.indiana.edu:1521:KUALI" 
    		     value="oracle.datasource.url=jdbc:oracle:thin:@localhost:1521:XE" />
			<!-- misc -->
			<replacefilter token="feedback.link.url=https://test.kuali.org/jira/secure/CreateIssue.jspa?pid=10091&amp;amp;issuetype=1" value="feedback.link.url=" />
			<replacefilter token="licensing.contact.email=license@kuali.org" value="licensing.contact.email=" />
      	</replace>
		<move file="${all.temp.directory}/kfs/${build.distribution.directory}/impex-build.properties"
			  todir="${all.temp.directory}" failonerror="false" />
	</target>
	
	<target name="unpack-and-remove-rice-licenses" depends="init-properties,init-additional-properties">
		<unzip dest="${all.temp.directory}/kfs/${build.distribution.licenses.directory}/${rice.name}" 
			   src="${all.temp.directory}/kfs/${build.project.directory}/${rice.name}-${kfs.rice.version}${rice.output.licenses.suffix}" />
		<delete file="${all.temp.directory}/kfs/${build.project.directory}/${rice.name}-${kfs.rice.version}${rice.output.licenses.suffix}" />
	</target>
	
	<target name="add-doc-files" depends="init-properties,init-additional-properties">
		<!-- get any *.txt files we drop in the build/distribution directory -->
		<move todir="${all.temp.directory}" verbose="true">
			<fileset dir="${all.temp.directory}/kfs/build/distribution">
				<include name="*.txt" />
			</fileset>
		</move>
		<!-- get the current revision numbers for each SVN path we are including in the export -->
		<svn>
			<info target="${kuali.svn.root}/${kfs.svn.module}/${kfs.svn.path}"
				  propPrefix="svn.info.kfs" verbose="true" />			
			<info target="${kuali.svn.root}/${rice.svn.module}/${rice.svn.path}"
				  propPrefix="svn.info.rice" verbose="true" />			
			<info target="${kuali.svn.root}/${kfs.database.svn.module}/${kfs.database.demo.svn.path}"
				  propPrefix="svn.info.kfsdb.demo" verbose="true" />			
			<info target="${kuali.svn.root}/${kfs.database.svn.module}/${kfs.database.bootstrap.svn.path}"
				  propPrefix="svn.info.kfsdb.bootstrap" verbose="true" />			
			<info target="${kuali.svn.root}/${rice.database.svn.module}/${rice.database.demo.svn.path}"
				  propPrefix="svn.info.ricedb.demo" verbose="true" />			
			<info target="${kuali.svn.root}/${rice.database.svn.module}/${rice.database.bootstrap.svn.path}"
				  propPrefix="svn.info.ricedb.bootstrap" verbose="true" />			
			<info target="${kuali.svn.root}/${impex.tool.svn.module}/${impex.tool.svn.path}"
				  propPrefix="svn.info.impex" verbose="true" />			
		</svn>
	    <!-- dump a file with the extracted tags -->
    	<echo file="${all.temp.directory}/release-details.txt">
      		KFS URL: ${kfs.svn.module}/${kfs.svn.path} (@${svn.info.kfs.lastRev})
      		Demo Dataset URLs: 
    				KFS:  ${kfs.database.svn.module}/${kfs.database.demo.svn.path} (@${svn.info.kfsdb.demo.lastRev})
    				Rice: ${rice.database.svn.module}/${rice.database.demo.svn.path} (@${svn.info.kfsdb.bootstrap.lastRev})
      		Bootstrap Dataset URLs: 
    				KFS:  ${kfs.database.svn.module}/${kfs.database.bootstrap.svn.path} (@${svn.info.ricedb.demo.lastRev})
    				Rice: ${rice.database.svn.module}/${rice.database.bootstrap.svn.path} (@${svn.info.ricedb.bootstrap.lastRev})
      		Impex URL: ${impex.tool.svn.module}/${impex.tool.svn.path} (@${svn.info.impex.lastRev})
      		Rice URL: ${rice.svn.module}/${rice.svn.path} (@${svn.info.rice.lastRev})
    	</echo>	
	</target>
	
	<target name="zip-package" depends="init-properties">
	    <!-- zip it up -->
    	<zip destfile="${release.zip.name}" basedir="${all.temp.directory}" compress="true" />
	</target>
	
	<target name="make-javadoc-for-dist" depends="init-properties,init-additional-properties,init-make-references">
    	<!-- setup destination directories -->
		<property name="javadoc.temp.path" value="${all.temp.directory}/javadoc" />
    	<mkdir dir="${javadoc.temp.path}" />
    	<mkdir dir="${javadoc.temp.path}/kfs" />
    	<mkdir dir="${javadoc.temp.path}/rice/api" />
    	<mkdir dir="${javadoc.temp.path}/rice/impl" />
  		<!-- create javadocs from rice project -->
  		<javadoc destdir="${javadoc.temp.path}/rice/api"  
  				 packagenames="org.*" excludepackagenames="org.kuali.rice.test.*" 
  				 sourcepath="${all.temp.directory}/rice/api/src/main/java"
  				 classpathref="compile.source.classpath" 
		  		 maxmemory="${javadoc.max.memory}" />
  		<javadoc destdir="${javadoc.temp.path}/rice/impl" 
  				 packagenames="org.*" excludepackagenames="org.kuali.rice.test.*,org.kuali.rice.kim.client.acegi.*,org.kuali.rice.core.web.jetty.*"
  				 sourcepath="${all.temp.directory}/rice/impl/src/main/java"
				 classpathref="compile.source.classpath" 
		  		 maxmemory="${javadoc.max.memory}" />
 	
    	<!-- create javadoc target for kfs docs -->
		<javadoc destdir="${javadoc.temp.path}/kfs" 
				 packagenames="org.*" 
				 locale="en" 
				 useexternalfile="yes" 
				 maxmemory="${javadoc.max.memory}">
      		<sourcepath>
      			<pathelement location="${all.temp.directory}/kfs/${source.directory}"/>
  			</sourcepath>
      		<classpath refid="compile.source.classpath"/>
    	</javadoc>
    
    	<!-- create zip file from javadoc directories -->
    	<zip basedir="${javadoc.temp.path}" destfile="${all.temp.directory}/kfs-javadoc.zip" />
    
    	<!-- clear temp directories -->
    	<delete dir="${javadoc.temp.path}" />
	</target>
	  
</project>